import e from"express";import s from"dotenv";import t from"mongoose";import{connectDb as a}from"./config/db.js";import o from"../services/ExchangeService.js";import r from"./models/ClientWalletSchema.js";import n from"../services/CalculateChangeService.js";import c from"path";import{fileURLToPath as i}from"url";const m=i(import.meta.url),g=c.dirname(m);s.config();const p=e();p.use(e.json()),p.use(e.urlencoded({extended:!0})),p.use(e.static("assets")),p.set("view engine","ejs"),p.set("views",c.join(g,"views")),p.post("/api/payment",async(e,s)=>{const{amount:t,exchange:a,bigBills:c}=e.body;try{const e=await n.calculateChange(t,a,c);if(!e.success)return s.status(400).json(e);const i=await o.getExchange();Object.assign(i,e.updatedCaisse),await i.save();const m=new r({amount:t,exchange:a,bigBills:c});await m.save(),s.json({success:!0,changeToGive:e.changeToGive})}catch(e){console.error(e),s.status(500).json({message:"Erreur serveur"})}}),p.get("/",async(e,s)=>{s.redirect("/payment")}),p.get("/payment",(e,s)=>{s.render("payment")}),p.get("/change",(e,s)=>{const{data:t}=e.query;let a={};try{t&&(a=JSON.parse(decodeURIComponent(t)))}catch(e){console.error("Erreur parsing change data")}s.render("change",{changeToGive:a})});export default p;